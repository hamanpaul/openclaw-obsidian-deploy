services:
  openclaw-obsidian-maintainer:
    image: ${OPENCLAW_OBSIDIAN_IMAGE:-openclaw-obsidian:local}
    build:
      context: ${OPENCLAW_OPS_DIR:-.}
      dockerfile: ${OPENCLAW_OBSIDIAN_DOCKERFILE:-./Dockerfile}
      args:
        OPENCLAW_BASE_IMAGE: ${OPENCLAW_BASE_IMAGE:-openclaw:v2026.2.15}
        OPENCLAW_DOCKER_APT_PACKAGES: ${OPENCLAW_DOCKER_APT_PACKAGES:-ca-certificates curl jq git ripgrep fd-find yq rsync tzdata python3 python-is-python3}
        OPENCLAW_DOCKER_USER: ${OPENCLAW_DOCKER_USER:-1000:1000}
    user: "${OPENCLAW_DOCKER_USER:-1000:1000}"
    working_dir: /app
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OBSIDIAN_VAULT_DIR: /workspace/vault
      OPENCLAW_REPO_DIR: /app
      OBSTOOLS_DIR: /workspace/vault/ObsToolsVault
      OPENCLAW_EXTERNAL_MD_DIR: /workspace/vault/openclaw
      STATE_DIR: /workspace/vault/ObsToolsVault/state
      STATE_FILE: /workspace/vault/ObsToolsVault/state/openclaw_obsidian_state.json
      QUEUE_FILE: /workspace/vault/ObsToolsVault/state/openclaw_obsidian_queue.json
      MANIFEST_FILE: /workspace/vault/ObsToolsVault/state/openclaw_md_manifest.json
      MIGRATION_SUGGESTIONS_FILE: /workspace/vault/ObsToolsVault/specs/migration_suggestions.md
      AGENT_EXECUTE_GUIDE_FILE: /workspace/vault/ObsToolsVault/specs/agent_execute_guide.md
      SCAN_INTERVAL_SEC: ${SCAN_INTERVAL_SEC:-60}
      INIT_EXTERNALIZE_MD: ${INIT_EXTERNALIZE_MD:-1}
      OPENCLAW_AGENT_ID: ${OPENCLAW_AGENT_ID:-main}
      OPENCLAW_DEFAULT_MODEL: ${OPENCLAW_DEFAULT_MODEL:-github-copilot/gpt-5-mini}
      OPENCLAW_DEFAULT_PROFILE_ID: ${OPENCLAW_DEFAULT_PROFILE_ID:-github-copilot:github}
      OPENCLAW_ENABLE_TELEGRAM_PLUGIN: ${OPENCLAW_ENABLE_TELEGRAM_PLUGIN:-1}
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN:-local-dev-token}
      OPENCLAW_CONTROL_UI_ALLOW_INSECURE_AUTH: ${OPENCLAW_CONTROL_UI_ALLOW_INSECURE_AUTH:-1}
      CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY:-}
      CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY:-}
      CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE:-}
    volumes:
      - ${OBSIDIAN_VAULT_HOST_DIR}:/workspace/vault
      - ${OPENCLAW_CONFIG_HOST_DIR}:/home/node/.openclaw
    entrypoint: ["/bin/bash"]
    command: ["/ops/scripts/maintainer-loop.sh"]
    init: true
    restart: unless-stopped

  openclaw-obsidian-gateway:
    image: ${OPENCLAW_OBSIDIAN_IMAGE:-openclaw-obsidian:local}
    user: "${OPENCLAW_DOCKER_USER:-1000:1000}"
    working_dir: /app
    depends_on:
      - openclaw-obsidian-maintainer
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN:-local-dev-token}
      OPENCLAW_GATEWAY_PORT: ${OPENCLAW_GATEWAY_PORT:-18789}
      OPENCLAW_DEFAULT_MODEL: ${OPENCLAW_DEFAULT_MODEL:-github-copilot/gpt-5-mini}
      OPENCLAW_DEFAULT_PROFILE_ID: ${OPENCLAW_DEFAULT_PROFILE_ID:-github-copilot:github}
      OPENCLAW_ENABLE_TELEGRAM_PLUGIN: ${OPENCLAW_ENABLE_TELEGRAM_PLUGIN:-1}
      OPENCLAW_CONTROL_UI_ALLOW_INSECURE_AUTH: ${OPENCLAW_CONTROL_UI_ALLOW_INSECURE_AUTH:-1}
    volumes:
      - ${OBSIDIAN_VAULT_HOST_DIR}:/workspace/vault
      - ${OPENCLAW_CONFIG_HOST_DIR}:/home/node/.openclaw
    ports:
      - "${OPENCLAW_GATEWAY_PORT:-18789}:${OPENCLAW_GATEWAY_PORT:-18789}"
    entrypoint: ["/bin/bash", "-lc"]
    command:
      [
        "/ops/scripts/ensure-openclaw-config.sh && /ops/scripts/ensure-zh-tw-default.sh && exec node /app/openclaw.mjs gateway run",
      ]
    init: true
    restart: unless-stopped
